#include "statemachine.h"
#include "engine.h"
#include "input.h"
#include "intro.h"
#include "menu.h"
using namespace std;
using namespace gp2d;

namespace game {

iteam* iteam::m_self = NULL;

iteam::iteam(){}
iteam::~iteam(){}
iteam* iteam::instance() {
    if(m_self == NULL) { m_self = new iteam(); }
    return m_self;
}

GP2DEngine* iteam::engine(){
	return m_engine;
}

GP2DWindow* iteam::window(){
	return m_window;
}

GP2DInputHandler* iteam::input(){
	return m_input;
}

GP2DDirector* iteam::director(){
	return m_camDirector;
}

GP2DGuiCamera* iteam::camGui(){
	return m_camGui;
}

GP2DGameCamera* iteam::camGame(){
	return m_camGame;
}

void iteam::init(){
	m_engine = GP2DEngine::getInstance();
	m_engine->initAll();
	
	m_window = GP2DWindow::getInstance();
	m_window->setRenderMode(GP2DWindow::GP2D_OPENGL);
	m_window->setWindowTitle("iteam");
	m_window->createWindow(1024, 768, 24);
	m_window->setGraphicsDefaults();
	// m_window->createNewCamera();
	
    m_camGame = new GP2DGameCamera();
    m_camGame->setPosition(100.0f, 100.0f);

    m_camGui = new GP2DGuiCamera();
    m_camGui->setDefaults();	
	
	m_camDirector = new GP2DDirector(m_camGame, m_camGui);
	
	m_input = new GP2DInputHandler();
	
	m_quit = false;
	setState(INTRO);
}

void iteam::quit(){
	m_quit = true;
}

void iteam::run(){
	m_input->registerGlobalKeyAction(new introAction());
	m_intro = new iteamIntro();
	m_menu = new iteamMenu();

	while(m_quit == false) {
		m_input->handleInputEvents();
		m_window->clearScreen();
		
		switch (getState()){
			case INTRO:
				m_intro->run();
			break;
				
			case FREE_INTRO:
				delete m_intro; m_intro = NULL;
				setNextState(MENU);
				nextState();
			break;
			
			case MENU:
				m_menu->run();
			break;
		}
		
		m_window->sync();
		SDL_Delay(10);
	}
}

}
